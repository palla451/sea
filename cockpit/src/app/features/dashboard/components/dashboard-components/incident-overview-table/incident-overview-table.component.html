<div class="table-wrapper">
  @if( isTableDataLoading ){
  <app-local-spinner></app-local-spinner>
  }@else{ @if(isIncidentModalOpened){
  <app-base-readonly-modal
    [isModalVisible]="isIncidentModalOpened"
    [modalTitle]="'remediationManagementModal.title' | transloco"
    [heightPx]="850"
    (modalClosed)="manageModalClosedState()"
  >
    <app-incident-management-modal></app-incident-management-modal>
  </app-base-readonly-modal>
  }

  <main class="incident-overview-table">
    <app-column-settings-sidebar
      [tableContext]="'dashboard'"
      [isOpen]="showSettingsSidebar"
      (onSidebarClosing)="onSettingsSidebarClosing()"
    ></app-column-settings-sidebar>

    <app-table-filters-sidebar
      [table]="incidentOVtable"
      [isOpen]="showFiltersSidebar"
      (onSidebarClosing)="onFiltersSidebarClosing()"
    ></app-table-filters-sidebar>

    <div class="incident-overview-table__header">
      <div class="incident-overview-table__header--title">
        <span>{{
          "dashboardPage.incidentOverviewTable.title" | transloco
        }}</span>
      </div>
      <div class="incident-overview-table__header--call-to-actions">
        <button
          (click)="toggleSettings()"
          class="incident-overview-table__header--call-to-actions--settings settingsBtn"
        >
          <span class="label">{{ "common.button.settings" | transloco }}</span>
          <span class="icon">
            <img src="assets/svg/gear.svg" alt="Settings Icon" />
          </span>
        </button>

        <button
          class="custom-button filtersBtn"
          (click)="toggleFilters()"
        >
          @if(activeSidebarFiltersCount() > 0){
          <div class="filtersAppliedAmount">
            <span>{{ activeSidebarFiltersCount() }}</span>
          </div>
          }
          <span class="label">{{ "common.button.filters" | transloco }}</span>
          <span class="icon">
            <img src="assets/svg/filter.svg" alt="Filters Icon" />
          </span>
        </button>
      </div>
    </div>
    <p-table
      #incidentOVtable
      dataKey="id"
      currentPageReportTemplate=""
      [columns]="selectedColumns()"
      [value]="incidentsSignal() ?? []"
      [paginator]="true"
      [rows]="rows()"
      [resizableColumns]="true"
      sortMode="multiple"
      [responsiveLayout]="'stack'"
      [showCurrentPageReport]="false"
      [showFirstLastIcon]="false"
      [autoLayout]="true"
      (onPage)="onPageChange($event)"
    >
      <ng-template #header let-columns>
        <tr>
          @for ( col of columns; track col.field ) { @if (col.visible &&
          (col.field !== 'linkToIncidentManage' || (hasPrivilegedAccess$ |
          async))) { @if(col.sortable){
          <th
            pSortableColumn="{{ col.field }}"
            [ngClass]="{
            columnTitleEnd:
              col.field === 'assetsInvolved' || col.field === 'mvz',
            assetsInvolvedWidth: col.field === 'assetsInvolved',
            mvzWidth: col.field === 'mvz',
            descriptionWidth: col.field === 'description',
            dateWidth: col.field === 'createdAt',
            alertLevelWidth: col.field === 'severity',
          }"
          >
            {{ col.header }}
            <p-sortIcon field="{{ col.field }}"></p-sortIcon>
          </th>
          } @else {
          <th
            [ngClass]="{
              columnTitleEnd: (col.field === 'deck' || col.field === 'frame'),
              incidentIdWidth: col.field === 'id',
              decksInvolvedWidth: col.field === 'deck',
              framesInvolvedWidth: col.field === 'frame',
              linkToIncidentOVWidth: col.field === 'linkToIncidentOV',
              linkToIncidentManageWidth: col.field === 'linkToIncidentManage',
            }"
          >
            {{ col.header }}
          </th>
          } } }
        </tr>
      </ng-template>

      <ng-template pTemplate="sorticon" let-sortOrder>
        <ng-container *ngIf="sortOrder === 0">
          <img
            src="assets/svg/sorting-ascending-descending.svg"
            alt="Ascending-Descending"
            class="ascendingDescendingSortIcon"
          />
        </ng-container>
        <ng-container *ngIf="sortOrder === 1">
          <img
            src="assets/svg/sorting-ascending.svg"
            alt="Ascending"
            class="ascendingSortIcon"
          />
        </ng-container>
        <ng-container *ngIf="sortOrder === -1">
          <img src="assets/svg/sorting-descending.svg" alt="Descending" />
        </ng-container>
      </ng-template>

      <ng-template pTemplate="body" let-incident>
        <tr
          class="incident-row"
          (mouseenter)="onRowHover(incident)"
          (mouseleave)="onRowLeave()"
        >
          @if (checkIfColumnIsVisible(((selectedColumns())),'id')) {
          <td>
            <span>{{ incident?.id }}</span>
          </td>
          } @if (checkIfColumnIsVisible(((selectedColumns())),'description')){
          <td class="incident-overview-table__description">
            {{ incident.title }}
          </td>
          } @if (checkIfColumnIsVisible(((selectedColumns())),'deck')){
          <td class="incident-overview-table__deck">
            {{ getFormattedList(incident.decks) }}
          </td>
          } @if (checkIfColumnIsVisible(((selectedColumns())),'frame')){
          <td class="incident-overview-table__frame">
            <span>
              {{ getFormattedList(incident.frames) }}
            </span>
          </td>
          } @if
          (checkIfColumnIsVisible(((selectedColumns())),'assetsInvolved')){
          <td class="incident-overview-table__assetInvolved">
            {{ incident.assetsInvolved }}
          </td>
          } @if (checkIfColumnIsVisible(((selectedColumns())),'mvz')){
          <td class="incident-overview-table__mvz">
            {{ getFormattedList(incident.mvz) }}
          </td>
          } @if (checkIfColumnIsVisible(((selectedColumns())),'severity')){
          <td>
            <div class="incident-overview-table__alert-level">
              <span
                class="incident-overview-table__alert-level--alert-icon"
                [ngStyle]="{
                'background-color': getAlertSeverityColor(capitalizeFirstLetter(incident.severity)),
                'box-shadow': getAlertSeverityShadow(capitalizeFirstLetter(incident.severity)),
              }"
              ></span>
              <span class="incident-overview-table__alert-level--alert-hint">
                {{ capitalizeFirstLetter(incident.severity) }}</span
              >
            </div>
          </td>
          } @if (checkIfColumnIsVisible(((selectedColumns())),'createdAt')){
          <td class="incident-overview-table__creationDate">
            {{ incident.createdAt | date : "dd/MM/yyyy - HH:mm" }}
          </td>
          } @if ((hasPrivilegedAccess$ | async)) {
          <td>
            <div
              class="manageButtonContainer"
              (click)="incidentSelected(incident)"
            >
              <app-incident-manage-button
                (click)="onIncidentManageClick(incident)"
              ></app-incident-manage-button>
            </div>
          </td>
          }

          <td>
            <a class="p-text-primary" (click)="onIncidentClick(incident)">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                viewBox="0 0 16 16"
                fill="none"
              >
                <path
                  d="M11.7055 7.99995L11.3523 8.35308L5.35234 14.3531L4.99922 14.7062L4.29297 14L4.64609 13.6468L10.293 7.99995L4.64609 2.35308L4.29297 1.99995L4.99922 1.2937L5.35234 1.64683L11.3523 7.64683L11.7055 7.99995Z"
                  fill="white"
                />
              </svg>
            </a>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td></td>
          <td>
            <div class="no-records-message">
              {{
                "dashboardPage.incidentOverviewTable.noIncidentsFound"
                  | transloco
              }}
            </div>
          </td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
        </tr>
      </ng-template>
    </p-table>

    <div class="incident-overview-table__paginator-container">
      <div class="incident-overview-table__paginator-container__report">
        @if (incidents && incidents.length) {
        <span
          >Items: {{ first() + 1 }} -
          {{
            first() + rows() < incidents.length
              ? first() + rows()
              : incidents.length
          }}
          of {{ incidentsSignal()?.length ?? "" }}
        </span>
        }
      </div>
    </div>
  </main>
  }
</div>
