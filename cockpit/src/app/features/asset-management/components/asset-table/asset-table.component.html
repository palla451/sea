<main class="incident-overview-table">
  <app-column-settings-sidebar
    [tableContext]="'assetsMgmt'"
    [isOpen]="showSettingsSidebar"
    (onSidebarClosing)="onSidebarClosing()"
  ></app-column-settings-sidebar>

  <app-table-filters-sidebar
    [table]="assetsMNGMTtable"
    [isOpen]="showFiltersSidebar"
    (onSidebarClosing)="onFiltersSidebarClosing()"
  ></app-table-filters-sidebar>

  <div class="incident-overview-table__header">
    <div class="incident-overview-table__header--title">
      <span>{{ "assetManagementPage.assetsTable.title" | transloco }}</span>
    </div>
    <div class="incident-overview-table__header--call-to-actions">
      <button
        (click)="toggleSettings()"
        class="incident-overview-table__header--call-to-actions--settings settingsBtn"
      >
        <span class="label">{{ "common.button.settings" | transloco }}</span>
        <span class="icon">
          <img src="assets/svg/gear.svg" alt="Settings Icon" />
        </span>
      </button>

      <button
        class="custom-button"
        (click)="toggleFilters()"
        class="incident-overview-table__header--call-to-actions--filters filtersBtn"
      >
        @if(((activeSidebarFiltersCount$ | async ) ?? 0) > 0){
        <div class="filtersAppliedAmount">
          <span>{{ activeSidebarFiltersCount$ | async }}</span>
        </div>
        }
        <span class="label">{{ "common.button.filters" | transloco }}</span>
        <span class="icon">
          <img src="assets/svg/filter.svg" alt="Filters Icon" />
        </span>
      </button>
    </div>
  </div>
  <p-table
    #assetsMNGMTtable
    dataKey="id"
    currentPageReportTemplate=""
    [columns]="(selectedColumns$ | async) ?? []"
    [value]="assets"
    [paginator]="true"
    [rows]="rows()"
    [resizableColumns]="true"
    sortMode="multiple"
    [responsiveLayout]="'stack'"
    [showCurrentPageReport]="false"
    [showFirstLastIcon]="false"
    [autoLayout]="true"
    (onPage)="onPageChange($event)"
  >
    <ng-template #header let-columns>
      <tr>
        @for ( col of columns; track col.field ) { @if (col.visible &&
        (col.field !== 'editModal' || (hasPrivilegedAccess$ | async))) {
        @if(col.sortable){
        <th
          pSortableColumn="{{ col.field }}"
          [ngClass]="{
              descriptionWidth: col.field === 'type',
              nameWidth: col.field === 'name',
              statusWidth: col.field === 'status',
            }"
        >
          {{ col.header }}
          <p-sortIcon field="{{ col.field }}"></p-sortIcon>
        </th>
        } @else {
        <th
          [ngClass]="{
          markPieceWidth: col.field === 'markPiece',
          editModalWidth: col.field === 'editModal',
        }"
        >
          {{ col.header }}
        </th>
        } } }
      </tr>
    </ng-template>

    <ng-template pTemplate="sorticon" let-sortOrder>
      <ng-container *ngIf="sortOrder === 0">
        <img
          src="assets/svg/sorting-ascending-descending.svg"
          alt="Ascending-Descending"
          class="ascendingDescendingSortIcon"
        />
      </ng-container>
      <ng-container *ngIf="sortOrder === 1">
        <img
          src="assets/svg/sorting-ascending.svg"
          alt="Ascending"
          class="ascendingSortIcon"
        />
      </ng-container>
      <ng-container *ngIf="sortOrder === -1">
        <img src="assets/svg/sorting-descending.svg" alt="Descending" />
      </ng-container>
    </ng-template>

    <ng-template pTemplate="body" let-asset>
      <tr>
        @if (checkIfColumnIsVisible(((selectedColumns$ |
        async)??[]),'markPiece')) {
        <td>
          <span>{{ asset.pieceMark }}</span>
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns$ | async)??[]),'type')){
        <td>
          <span class="incident-overview-table__description">{{
            asset.systemInfo
          }}</span>
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns$ | async)??[]),'name')){
        <td class="incident-overview-table__name">
          {{ asset.name }}
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns$ |
        async)??[]),'status')){

        <td class="incident-overview-table__status">
          <div class="incident-overview-table__status__alert-level">
            <span
              class="incident-overview-table__status__alert-level--icon"
              [ngStyle]="{
                'background-color': getAlertSeverityColor(asset.status),
                'box-shadow': getAlertSeverityShadow(asset.status),
              }"
            ></span>
            <span class="incident-overview-table__status__alert-level--hint">
              {{ asset.status }}</span
            >
          </div>
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns$ |
        async)??[]),'editModal')&& (hasPrivilegedAccess$ | async)){
        <td class="incident-overview-table__editModal">
          <a (click)="openAssetModal(asset)">
            <img src="../../../../../assets/svg/Edit icon.svg" alt="Edit" />
          </a>
        </td>
        }
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td></td>
        <td><div class="no-records-message">There are no assets found</div></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    </ng-template>
  </p-table>

  <div class="incident-overview-table__paginator-container">
    <div class="incident-overview-table__paginator-container__report">
      @if (assets && assets.length) {
      <span
        >Items: {{ first() + 1 }} -
        {{
          first() + rows() < assets.length ? first() + rows() : assets.length
        }}
        of {{ assets.length }}
      </span>
      }
    </div>
  </div>
</main>
