<main class="incident-overview-table">
  <app-column-settings-sidebar
    [tableContext]="'history'"
    [isOpen]="showSettingsSidebar"
    (onSidebarClosing)="onSettingsSidebarClosing()"
  ></app-column-settings-sidebar>

  <app-table-filters-sidebar
    [table]="incidentHistorytable"
    [isOpen]="showFiltersSidebar"
    (onSidebarClosing)="onFiltersSidebarClosing()"
  ></app-table-filters-sidebar>

  <div class="incident-overview-table__header">
    <div class="incident-overview-table__header--title">
      <span>{{ "historyPage.historyTable.title" | transloco }}</span>
    </div>
    <div class="incident-overview-table__header--call-to-actions">
      <button
        (click)="toggleSettings()"
        class="incident-overview-table__header--call-to-actions--settings settingsBtn"
      >
        <span class="label">{{ "common.button.settings" | transloco }}</span>
        <span class="icon">
          <img src="assets/svg/gear.svg" alt="Settings Icon" />
        </span>
      </button>

      <button
        class="custom-button"
        (click)="toggleFilters()"
        class="incident-overview-table__header--call-to-actions--filters filtersBtn"
      >
        @if(((activeSidebarFiltersCount$ | async ) ?? 0) > 0){
        <div class="filtersAppliedAmount">
          <span>{{ activeSidebarFiltersCount$ | async }}</span>
        </div>
        }
        <span class="label">{{ "common.button.filters" | transloco }}</span>
        <span class="icon">
          <img src="assets/svg/filter.svg" alt="Filters Icon" />
        </span>
      </button>
    </div>
  </div>
  <p-table
    #incidentHistorytable
    dataKey="id"
    currentPageReportTemplate=""
    [columns]="selectedColumns()"
    [value]="incidentsSignal()"
    [paginator]="true"
    [rows]="rows()"
    [resizableColumns]="true"
    sortMode="multiple"
    [responsiveLayout]="'stack'"
    [showCurrentPageReport]="false"
    [showFirstLastIcon]="false"
    [autoLayout]="true"
    (onPage)="onPageChange($event)"
  >
    <ng-template #header let-columns>
      <tr>
        @for ( col of columns; track col.field ) { @if (col.visible) {
        @if(col.sortable){
        <th
          pSortableColumn="{{ col.field }}"
          [ngClass]="{
            columnTitleEnd:
              col.field === 'assetsInvolved' || col.field === 'mvz',
            assetsInvolvedWidth: col.field === 'assetsInvolved',
            mvzWidth: col.field === 'mvz',
            linkToIncidentOVWidth: col.field === 'linkToIncidentOV',
            linkToIncidentManageWidth: col.field === 'linkToIncidentManage',
            descriptionWidth: col.field === 'description',
            dateWidth: col.field === 'createdAt',
            alertLevelWidth: col.field === 'alert',
            statusWidth: col.field === 'status',
          }"
        >
          {{ col.header }}
          <p-sortIcon field="{{ col.field }}"></p-sortIcon>
        </th>
        } @else {
        <th
          [ngClass]="{
            columnTitleEnd: col.field === 'deck' || col.field === 'frame'
          }"
        >
          {{ col.header }}
        </th>
        } } }
      </tr>
    </ng-template>

    <ng-template pTemplate="sorticon" let-sortOrder>
      <ng-container *ngIf="sortOrder === 0">
        <img
          src="assets/svg/sorting-ascending-descending.svg"
          alt="Ascending-Descending"
          class="ascendingDescendingSortIcon"
        />
      </ng-container>
      <ng-container *ngIf="sortOrder === 1">
        <img
          src="assets/svg/sorting-ascending.svg"
          alt="Ascending"
          class="ascendingSortIcon"
        />
      </ng-container>
      <ng-container *ngIf="sortOrder === -1">
        <img src="assets/svg/sorting-descending.svg" alt="Descending" />
      </ng-container>
    </ng-template>

    <ng-template pTemplate="body" let-incident>
      <tr>
        @if (checkIfColumnIsVisible(((selectedColumns())),'id')) {
        <td>
          <span>{{ incident?.id }}</span>
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns())),'description')){
        <td class="incident-overview-table__description">
          {{ incident.description }}
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns())),'deck')){
        <td class="incident-overview-table__deck">
          {{ getFormattedList(incident.decks) }}
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns())),'frame')){
        <td class="incident-overview-table__frame">
          {{ getFormattedList(incident.frames) }}
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns())),'assetsInvolved')){
        <td class="incident-overview-table__assetInvolved">
          {{ incident.assetsInvolved }}
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns())),'status')){
        <td class="incident-overview-table__status">
          {{ mapClosedStatusLabel(incident.status) }}
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns())),'mvz')){
        <td class="incident-overview-table__mvz">
          {{ getFormattedList(incident.mvz) }}
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns())),'severity')){
        <td>
          <div class="incident-overview-table__alert-level">
            <span
              class="incident-overview-table__alert-level--alert-icon"
              [ngStyle]="{
                'background-color': getAlertSeverityColor(incident.severity),
                'box-shadow': getAlertSeverityShadow(incident.severity),
              }"
            ></span>
            <span class="incident-overview-table__alert-level--alert-hint">
              {{ incident.severity }}</span
            >
          </div>
        </td>
        } @if (checkIfColumnIsVisible(((selectedColumns())),'createdAt')){
        <td class="incident-overview-table__creationDate">
          {{ incident.createdAt | date : "dd/MM/yyyy - HH:mm" }}
        </td>
        }
        <td>
          <a class="p-text-primary" (click)="onIncidentClick(incident?.id)">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              viewBox="0 0 16 16"
              fill="none"
            >
              <path
                fill-rule="evenodd"
                clip-rule="evenodd"
                d="M5.64645 3.64645C5.84171 3.45118 6.15829 3.45118 6.35355 3.64645L10.3536 7.64645C10.5488 7.84171 10.5488 8.15829 10.3536 8.35355L6.35355 12.3536C6.15829 12.5488 5.84171 12.5488 5.64645 12.3536C5.45118 12.1583 5.45118 11.8417 5.64645 11.6464L9.29289 8L5.64645 4.35355C5.45118 4.15829 5.45118 3.84171 5.64645 3.64645Z"
                fill="white"
              />
            </svg>
          </a>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td>
          <div class="no-records-message">There are no incidents found</div>
        </td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
      </tr>
    </ng-template>
  </p-table>

  <div class="incident-overview-table__paginator-container">
    <div class="incident-overview-table__paginator-container__report">
      @if (incidents && incidents.length) {
      <span
        >Items: {{ first() + 1 }} -
        {{
          first() + rows() < incidents.length
            ? first() + rows()
            : incidents.length
        }}
        of {{ incidents.length }}
      </span>
      }
    </div>
  </div>
</main>
